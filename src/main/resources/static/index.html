<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CLARIO Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Background bubbles */
    .bubble {
      position: absolute;
      bottom: -100px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      animation: rise 20s infinite ease-in;
    }
    @keyframes rise {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-120vh) scale(0.5); opacity: 0; }
    }

    /* Message animations */
    .message-enter {
      opacity: 0;
      transform: translateY(20px);
      animation: messageFade 0.5s forwards;
    }
    @keyframes messageFade {
      to { opacity: 1; transform: translateY(0); }
    }

    /* UI transitions */
    .fade-slide-up { opacity: 0; transform: translateY(20px); animation: fadeSlide 0.5s forwards; }
    @keyframes fadeSlide { to { opacity: 1; transform: translateY(0); } }
    .fade-out { animation: fadeOut 0.5s forwards; }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-50px); } }
    .scale-up { animation: scaleUp 0.5s forwards; }
    @keyframes scaleUp { to { transform: scale(1.2); opacity: 1; } }

    /* Scrollbar style */
    #messages::-webkit-scrollbar { width: 6px; }
    #messages::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 3px; }
  </style>
</head>
<body class="relative bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen font-sans overflow-hidden flex items-center justify-center">

  <!-- Animated Bubbles -->
  <div id="bubbles" class="absolute inset-0 -z-10"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 flex justify-center items-center px-6 py-4 bg-white shadow z-10 transition-all duration-500">
    <div id="appLogo" class="text-2xl font-extrabold text-indigo-600 tracking-wide transition-all duration-500">ChatApp</div>
  </header>

  <!-- Welcome Section -->
  <section id="welcomeSection" class="flex flex-col items-center justify-center text-center px-6 transition-all duration-500 z-10">
    <h1 id="welcomeTitle" class="text-5xl font-extrabold text-white drop-shadow-lg mb-6 transition-all duration-500">Welcome to ChatApp</h1>
    <p class="text-lg text-gray-200 max-w-xl mb-10 transition-all duration-500">Experience fast and secure real-time messaging like never before.</p>
    <button id="getStartedBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-3 rounded-full text-lg font-semibold shadow hover:opacity-90 transition-all duration-500">
      Get Started
    </button>
  </section>

  <!-- Main Container -->
  <div id="mainContainer" class="hidden flex items-center justify-center w-full h-full px-4 z-10">
    <div class="flex flex-col items-center justify-center w-full">

      <!-- Auth Container -->
      <div id="authContainer" class="bg-white shadow-2xl rounded-xl w-full max-w-md p-6 sm:p-8 fade-slide-up flex flex-col items-center justify-center">
        <!-- Login Page -->
        <div id="loginPage" class="w-full">
          <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">Login</h2>
          <div class="space-y-3">
            <input id="loginUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
            <input id="loginPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
            <button onclick="login()" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white px-4 py-2 rounded w-full transition">Login</button>
          </div>
          <p class="text-sm mt-3 text-center">Donâ€™t have an account? 
            <a href="#" onclick="showRegister()" class="text-blue-500 hover:underline">Register</a>
          </p>
          <p id="loginMsg" class="text-sm text-red-500 mt-2 text-center"></p>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="hidden w-full">
          <h2 class="text-2xl font-bold mb-4 text-gray-700 text-center">Register</h2>
          <div class="space-y-3">
            <input id="registerUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
            <input id="registerPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
            <input id="registerConfirm" type="password" placeholder="Confirm Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
            <button onclick="register()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:opacity-90 text-white px-4 py-2 rounded w-full transition">Register</button>
          </div>
          <p class="text-sm mt-3 text-center">Already have an account? 
            <a href="#" onclick="showLogin()" class="text-blue-500 hover:underline">Login</a>
          </p>
          <p id="registerMsg" class="text-sm text-red-500 mt-2 text-center"></p>
        </div>
      </div>

      <!-- Messaging Page -->
      <div id="messagingPage" class="hidden flex flex-col w-full h-screen bg-white shadow-2xl rounded-xl p-4 sm:p-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-xl font-bold text-gray-700">Welcome, <span id="userDisplay"></span></h2>
          <button onclick="logout()" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:opacity-90 transition">Logout</button>
        </div>

        <div id="messages" class="border p-3 flex-1 overflow-y-auto bg-gradient-to-r from-blue-100 via-indigo-100 to-purple-100 rounded-lg mb-4 flex flex-col shadow-inner space-y-2"></div>

        <div class="flex flex-col sm:flex-row gap-2">
          <input id="messageInput" type="text" placeholder="Type your message..." class="border p-2 rounded w-full focus:ring focus:ring-indigo-300 flex-1">
          <button onclick="sendMessage()" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white px-4 py-2 rounded transition w-full sm:w-auto">Send</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    let ws;
    let myUsername = "";

    // Background bubbles
    function createBubbles() {
      const bubbleContainer = document.getElementById("bubbles");
      for (let i = 0; i < 25; i++) {
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");
        const size = Math.random() * 60 + 20;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}%`;
        bubble.style.animationDuration = `${10 + Math.random() * 15}s`;
        bubbleContainer.appendChild(bubble);
      }
    }
    createBubbles();

    // UI Transitions
    function startApp() {
      document.getElementById("welcomeSection").classList.add("fade-out");
      const logo = document.getElementById("appLogo");
      logo.classList.add("scale-up");
      logo.innerText = "CLARIO";

      setTimeout(() => {
        document.getElementById("welcomeSection").classList.add("hidden");
        document.getElementById("mainContainer").classList.remove("hidden");
        document.getElementById("authContainer").classList.add("fade-slide-up");
      }, 500);
    }

    function showLogin() {
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("registerPage").classList.add("hidden");
    }
    function showRegister() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("registerPage").classList.remove("hidden");
    }
    function showMessaging() {
      document.getElementById("authContainer").classList.add("hidden");
      const messagingPage = document.getElementById("messagingPage");
      messagingPage.classList.remove("hidden");
    }
    function logout() {
      ws && ws.close();
      document.getElementById("messagingPage").classList.add("hidden");
      document.getElementById("authContainer").classList.remove("hidden");
      myUsername = "";
      document.getElementById("userDisplay").innerText = "";
    }

    // Auth
    async function register() {
      const username = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value.trim();
      const confirm = document.getElementById("registerConfirm").value.trim();
      if (password !== confirm) {
        document.getElementById("registerMsg").innerText = "Passwords do not match!";
        return;
      }
      const response = await fetch('/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const message = await response.text();
      document.getElementById("registerMsg").innerText = message;
      if (message.includes("successful")) showLogin();
    }

    async function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      const response = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const message = await response.text();
      document.getElementById("loginMsg").innerText = message;
      if (message.includes("successful")) {
        myUsername = username;
        document.getElementById("userDisplay").innerText = myUsername;
        showMessaging();
        startChat();
      }
    }

    // WebSocket Chat
    function startChat() {
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}/chat`);
      ws.onopen = () => console.log("Connected to WebSocket server");
      ws.onmessage = event => appendMessage(JSON.parse(event.data));

      // --- FIXED WRAPPER BELOW ---
      const originalOnMessage = ws.onmessage;
      ws.onmessage = function(event) {
          const msg = JSON.parse(event.data);
          if (msg.type === "emotion") {
              showEmotionPopup(`${msg.username} is ${msg.emotion}`);
          } else {
              if (originalOnMessage) originalOnMessage(event);
          }
      };
      // --- END OF FIXED WRAPPER ---

      ws.onclose = () => console.log("Disconnected from server");
    }
    

    function appendMessage(msg) {
      const messagesDiv = document.getElementById("messages");
      const wrapper = document.createElement("div");
      wrapper.className = "mb-2 max-w-xs message-enter";
      const bubble = document.createElement("div");
      const timeText = document.createElement("div");
      timeText.className = "text-[10px] text-gray-500 mt-1";
      const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (msg.username === myUsername) {
        wrapper.classList.add("self-end", "text-right");
        bubble.className = "bg-green-500 text-white px-4 py-2 rounded-2xl shadow";
        bubble.textContent = `You: ${msg.content}`;
      } else if (msg.username === "SYSTEM") {
        wrapper.classList.add("self-center", "text-center");
        bubble.className = "bg-yellow-200 text-black px-4 py-2 rounded-2xl font-bold shadow";
        bubble.textContent = msg.content;
      } else {
        wrapper.classList.add("self-start", "text-left");
        bubble.className = "bg-gray-300 text-black px-4 py-2 rounded-2xl shadow";
        bubble.textContent = `${msg.username}: ${msg.content}`;
      }

      timeText.textContent = time;
      wrapper.appendChild(bubble);
      wrapper.appendChild(timeText);
      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !ws) return;
      ws.send(JSON.stringify({ username: myUsername, content: text, timestamp: new Date() }));
      input.value = "";
    }

    // Emotion popup for detected emotions
    function showEmotionPopup(text) {
        const popup = document.createElement('div');
        popup.innerText = text;
        popup.style.position = 'fixed';
        popup.style.top = '10px';
        popup.style.left = '50%';
        popup.style.transform = 'translateX(-50%)';
        popup.style.background = 'yellow';
        popup.style.padding = '5px 10px';
        popup.style.borderRadius = '5px';
        popup.style.fontWeight = 'bold';
        popup.style.zIndex = '1000';
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 3000);
    }

    // --- FIX: attach Start button click listener ---
    document.getElementById("getStartedBtn").addEventListener("click", startApp);
  </script>
</body>
</html>
 